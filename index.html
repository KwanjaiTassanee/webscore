<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz I - Data Visualization</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2972/2972160.png" type="image/png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mitr">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/6a972cf3a7.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: "Mitr"; }
    </style>
</head>

<body>
    <div class="container">
        <br>
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card text-center">
                    <div class="card-header">
                        Data Visualization - Quiz I Results
                    </div>
                    <div class="card-body">
                        <form id="search-form" onsubmit="handleFormSubmit(event)">
                            <div class="form-group mb-2">
                                <label>แจ้งคะแนน Quiz I (เต็ม 10 คะแนน)</label>
                            </div>
                            <div class="form-group mx-sm-3 mb-2">
                                <select class="form-control" id="classSelect" required>
                                    <option value="">เลือกกลุ่มเรียน</option>
                                    <option value="ตล2-1 4 ปี ภาคปกติ">G10_Friday_ตล2-1 4 ปี ภาคปกติ</option>
                                    <option value="ตล2-2 4 ปี ภาคปกติ">G11_Thursday_ตล2-2 4 ปี ภาคปกติ</option>
                                    <option value="ตล.2-3 4 ปี ภาคปกติ">G12_Tuesday_ตล.2-3 4 ปี ภาคปกติ</option>
                                    <option value="ตล1-1_เทียบโอน">G13_Tuesday_ตล1-1_เทียบโอน</option>
                                    <option value="ตล1-2_เทียบโอน">G14_Wednesday_ตล1-2_เทียบโอน</option>
                                    <option value="ตล1-4_เทียบโอน ภาคสมทบ">G16_Sunday_ตล1-4_เทียบโอน ภาคสมทบ</option>
                                </select>
                            </div>
                            <div class="form-group mx-sm-3 mb-2">
                                <input type="text" class="form-control" id="searchtext" name="searchtext" placeholder="กรอกรหัสผ่าน" required>
                            </div>
                            <button type="submit" class="btn btn-primary mb-2">ค้นหา</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div id="search-results" class="table-responsive text-center"></div>
            </div>
        </div>
    </div>

    <script>
        async function fetchCSVData() {
            const csvURL = 'https://docs.google.com/spreadsheets/d/1N02iv-ueL5WZRWTL8AWz-rf3JQCo4a0V7nFvL7q8vzc/gviz/tq?tqx=out:csv';
            try {
                const response = await fetch(csvURL);
                const csvText = await response.text();
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        complete: results => resolve(results.data),
                        error: error => reject(error)
                    });
                });
            } catch (error) {
                console.error("Error fetching CSV:", error);
                return [];
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const searchtext = document.getElementById('searchtext').value;
            const selectedClass = document.getElementById('classSelect').value;
            const data = await fetchCSVData();
            
            const result = data.filter(row => 
                row['password'] === searchtext && row['classroom'] === selectedClass
            ).map(row => [row['classroom'], row['studentID'], row['name'], row['score'], row['ref']]);
            
            displayResults(result);
            document.getElementById("search-form").reset();
        }

        function displayResults(dataArray) {
            const resultsDiv = document.getElementById('search-results');
            if (dataArray.length > 0) {
                let resultTable = `<table class='table table-striped table-hover'>
                    <thead><tr><th>Room</th><th>Student ID</th><th>ชื่อ-นามสกุล</th><th>Score</th><th>หมายเหตุ</th></tr></thead>
                    <tbody>`;
                dataArray.forEach(row => {
                    resultTable += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td></tr>`;
                });
                resultTable += "</tbody></table>";
                resultsDiv.innerHTML = resultTable;
            } else {
                resultsDiv.innerHTML = "<div class='alert alert-danger'>Data Not Found!!!!</div>";
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
